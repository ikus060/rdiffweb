#!/usr/bin/make -f

include /usr/share/dpkg/pkg-info.mk

export SETUPTOOLS_SCM_PRETEND_VERSION_FOR_RDIFFWEB := $(DEB_VERSION_UPSTREAM)

# Force use of pyproject.toml
export PYBUILD_SYSTEM=pyproject

# For testing, we need a timezone
export TZ=UTC

%:
	dh $@ --buildsystem=pybuild --test-tox

execute_before_dh_auto_build:
	@echo "Checking for Ubuntu Jammy..."
	@if grep -q "Ubuntu 22.04" /etc/os-release; then \
		echo "Running on Ubuntu Jammy: Installing setuptools>=66,<=68"; \
		pip install "setuptools>=66,<=68"; \
	fi

execute_after_dh_auto_install:
	# Test files are not required for runtime
	rm -rf debian/rdiffweb/usr/lib/python*/dist-packages/rdiffweb/controller/tests
	rm -rf debian/rdiffweb/usr/lib/python*/dist-packages/rdiffweb/core/tests
	rm -rf debian/rdiffweb/usr/lib/python*/dist-packages/rdiffweb/tests
	rm -f  debian/rdiffweb/usr/lib/python*/dist-packages/rdiffweb/test.py
	
override_dh_installman:
	mkdir -p debian/rdiffweb/usr/share/man/man1
	PATH=debian/rdiffweb/usr/bin:$(PATH) \
	PYTHONPATH=debian/rdiffweb/usr/lib/python{version}/dist-packages:$(PYTHONPATH) \
	help2man --version-string "$(DEB_VERSION_UPSTREAM)" \
		--no-info \
		--name "A web interface to rdiff-backup repositories" \
		--no-discard-stderr \
		rdiffweb > \
		debian/rdiffweb/usr/share/man/man1/rdiffweb.1

execute_before_dh_auto_clean:
	rm -rf *.egg-info

# Generate orig.tar.gz
gentarball: SOURCE=rdiffweb
gentarball:
	git archive --format=tar HEAD --prefix=$(SOURCE)-$(DEB_VERSION_UPSTREAM)/ | gzip -9 > ../$(SOURCE)_$(DEB_VERSION_UPSTREAM).orig.tar.gz
	mk-origtargz --compression gzip ../$(SOURCE)_$(DEB_VERSION_UPSTREAM).orig.tar.gz
